# GS XFB test using two invocations and two buffers. Based on GS used
# at spec/arb_transform_feedback3/ext_interleaved_two_bufs.

[require]
SPIRV YES
GL >= 3.3
GLSL >= 4.50
GL_ARB_gl_spirv

[vertex shader passthrough]

[geometry shader spirv]
; Automatically generated from the GLSL by gen_gl_spirv_tests.py. DO NOT EDIT
; SPIR-V
; Version: 1.0
; Generator: Khronos Glslang Reference Front End; 7
; Bound: 84
; Schema: 0
               OpCapability Geometry
               OpCapability TransformFeedback
          %1 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel Logical GLSL450
               OpEntryPoint Geometry %main "main" %_ %gl_in %x1_out %gl_InvocationID %x2_out %x3_out %y1_out %y2_out
               OpExecutionMode %main Xfb
               OpExecutionMode %main InputPoints
               OpExecutionMode %main Invocations 2
               OpExecutionMode %main OutputPoints
               OpExecutionMode %main OutputVertices 1
               OpSource GLSL 450
               OpSourceExtension "GL_ARB_gpu_shader5"
               OpName %_ ""
               OpMemberDecorate %gl_PerVertex 0 BuiltIn Position
               OpMemberDecorate %gl_PerVertex 1 BuiltIn PointSize
               OpMemberDecorate %gl_PerVertex 2 BuiltIn ClipDistance
               OpMemberDecorate %gl_PerVertex 3 BuiltIn CullDistance
               OpDecorate %gl_PerVertex Block
               OpDecorate %_ XfbBuffer 0
               OpDecorate %_ XfbStride 24
               OpMemberDecorate %gl_PerVertex_0 0 BuiltIn Position
               OpMemberDecorate %gl_PerVertex_0 1 BuiltIn PointSize
               OpMemberDecorate %gl_PerVertex_0 2 BuiltIn ClipDistance
               OpMemberDecorate %gl_PerVertex_0 3 BuiltIn CullDistance
               OpDecorate %gl_PerVertex_0 Block
               OpDecorate %x1_out Location 0
               OpDecorate %x1_out XfbBuffer 0
               OpDecorate %x1_out XfbStride 24
               OpDecorate %x1_out Offset 0
               OpDecorate %gl_InvocationID BuiltIn InvocationId
               OpDecorate %x2_out Location 1
               OpDecorate %x2_out XfbBuffer 0
               OpDecorate %x2_out XfbStride 24
               OpDecorate %x2_out Offset 4
               OpDecorate %x3_out Location 2
               OpDecorate %x3_out XfbBuffer 0
               OpDecorate %x3_out XfbStride 24
               OpDecorate %x3_out Offset 12
               OpDecorate %y1_out Location 3
               OpDecorate %y1_out XfbBuffer 1
               OpDecorate %y1_out XfbStride 20
               OpDecorate %y1_out Offset 0
               OpDecorate %y2_out Location 4
               OpDecorate %y2_out XfbBuffer 1
               OpDecorate %y2_out XfbStride 20
               OpDecorate %y2_out Offset 4
       %void = OpTypeVoid
          %3 = OpTypeFunction %void
      %float = OpTypeFloat 32
    %v4float = OpTypeVector %float 4
       %uint = OpTypeInt 32 0
     %uint_1 = OpConstant %uint 1
%_arr_float_uint_1 = OpTypeArray %float %uint_1
%gl_PerVertex = OpTypeStruct %v4float %float %_arr_float_uint_1 %_arr_float_uint_1
%_ptr_Output_gl_PerVertex = OpTypePointer Output %gl_PerVertex
          %_ = OpVariable %_ptr_Output_gl_PerVertex Output
        %int = OpTypeInt 32 1
      %int_0 = OpConstant %int 0
%gl_PerVertex_0 = OpTypeStruct %v4float %float %_arr_float_uint_1 %_arr_float_uint_1
%_arr_gl_PerVertex_0_uint_1 = OpTypeArray %gl_PerVertex_0 %uint_1
%_ptr_Input__arr_gl_PerVertex_0_uint_1 = OpTypePointer Input %_arr_gl_PerVertex_0_uint_1
      %gl_in = OpVariable %_ptr_Input__arr_gl_PerVertex_0_uint_1 Input
%_ptr_Input_v4float = OpTypePointer Input %v4float
%_ptr_Output_v4float = OpTypePointer Output %v4float
%_ptr_Output_float = OpTypePointer Output %float
     %x1_out = OpVariable %_ptr_Output_float Output
    %float_1 = OpConstant %float 1
%_ptr_Input_int = OpTypePointer Input %int
%gl_InvocationID = OpVariable %_ptr_Input_int Input
    %v2float = OpTypeVector %float 2
%_ptr_Output_v2float = OpTypePointer Output %v2float
     %x2_out = OpVariable %_ptr_Output_v2float Output
    %float_2 = OpConstant %float 2
    %float_3 = OpConstant %float 3
    %v3float = OpTypeVector %float 3
%_ptr_Output_v3float = OpTypePointer Output %v3float
     %x3_out = OpVariable %_ptr_Output_v3float Output
    %float_4 = OpConstant %float 4
    %float_5 = OpConstant %float 5
    %float_6 = OpConstant %float 6
     %y1_out = OpVariable %_ptr_Output_float Output
    %float_7 = OpConstant %float 7
     %y2_out = OpVariable %_ptr_Output_v4float Output
    %float_8 = OpConstant %float 8
    %float_9 = OpConstant %float 9
   %float_10 = OpConstant %float 10
   %float_11 = OpConstant %float 11
       %main = OpFunction %void None %3
          %5 = OpLabel
         %21 = OpAccessChain %_ptr_Input_v4float %gl_in %int_0 %int_0
         %22 = OpLoad %v4float %21
         %24 = OpAccessChain %_ptr_Output_v4float %_ %int_0
               OpStore %24 %22
         %30 = OpLoad %int %gl_InvocationID
         %31 = OpConvertSToF %float %30
         %32 = OpFAdd %float %float_1 %31
               OpStore %x1_out %32
         %37 = OpLoad %int %gl_InvocationID
         %38 = OpConvertSToF %float %37
         %39 = OpFAdd %float %float_2 %38
         %41 = OpLoad %int %gl_InvocationID
         %42 = OpConvertSToF %float %41
         %43 = OpFAdd %float %float_3 %42
         %44 = OpCompositeConstruct %v2float %39 %43
               OpStore %x2_out %44
         %49 = OpLoad %int %gl_InvocationID
         %50 = OpConvertSToF %float %49
         %51 = OpFAdd %float %float_4 %50
         %53 = OpLoad %int %gl_InvocationID
         %54 = OpConvertSToF %float %53
         %55 = OpFAdd %float %float_5 %54
         %57 = OpLoad %int %gl_InvocationID
         %58 = OpConvertSToF %float %57
         %59 = OpFAdd %float %float_6 %58
         %60 = OpCompositeConstruct %v3float %51 %55 %59
               OpStore %x3_out %60
         %63 = OpLoad %int %gl_InvocationID
         %64 = OpConvertSToF %float %63
         %65 = OpFAdd %float %float_7 %64
               OpStore %y1_out %65
         %68 = OpLoad %int %gl_InvocationID
         %69 = OpConvertSToF %float %68
         %70 = OpFAdd %float %float_8 %69
         %72 = OpLoad %int %gl_InvocationID
         %73 = OpConvertSToF %float %72
         %74 = OpFAdd %float %float_9 %73
         %76 = OpLoad %int %gl_InvocationID
         %77 = OpConvertSToF %float %76
         %78 = OpFAdd %float %float_10 %77
         %80 = OpLoad %int %gl_InvocationID
         %81 = OpConvertSToF %float %80
         %82 = OpFAdd %float %float_11 %81
         %83 = OpCompositeConstruct %v4float %70 %74 %78 %82
               OpStore %y2_out %83
               OpEmitVertex
               OpEndPrimitive
               OpReturn
               OpFunctionEnd

[geometry shader]
#version 450
#extension GL_ARB_gpu_shader5 : enable

layout(points, invocations = 2) in;
layout(points, max_vertices = 1) out;

layout(location = 0, xfb_buffer = 0, xfb_offset = 0) out float x1_out;
layout(location = 1, xfb_buffer = 0, xfb_offset = 4) out vec2 x2_out;
layout(location = 2, xfb_buffer = 0, xfb_offset = 12) out vec3 x3_out;
layout(location = 3, xfb_buffer = 1, xfb_offset = 0) out float y1_out;
layout(location = 4, xfb_buffer = 1, xfb_offset = 4) out vec4 y2_out;

void main() {
  gl_Position = gl_in[0].gl_Position;
  x1_out = 1.0 + gl_InvocationID;
  x2_out = vec2(2.0 + gl_InvocationID, 3.0 + gl_InvocationID);
  x3_out = vec3(4.0 + gl_InvocationID, 5.0 + gl_InvocationID,
                6.0 + gl_InvocationID);
  y1_out = 7.0 + gl_InvocationID;
  y2_out = vec4(8.0 + gl_InvocationID, 9.0 + gl_InvocationID,
                10.0 + gl_InvocationID, 11.0 + gl_InvocationID);
  EmitVertex();
  EndPrimitive();
}

[test]

xfb buffer object 0 64
xfb buffer object 1 64

xfb draw arrays GL_POINTS 0 1

verify query_object GL_PRIMITIVES_GENERATED 2
verify query_object GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN 2

expected buffer 64
# first invocation
expected buffer float 0 1.0
expected buffer float 1 2.0
expected buffer float 2 3.0
expected buffer float 3 4.0
expected buffer float 4 5.0
expected buffer float 5 6.0
#second invocation
expected buffer float 6 2.0
expected buffer float 7 3.0
expected buffer float 8 4.0
expected buffer float 9 5.0
expected buffer float 10 6.0

probe xfb buffer float 0 11

expected buffer 64 # Not really needed, just to clean.
# first invocation
expected buffer float 0 7.0
expected buffer float 1 8.0
expected buffer float 2 9.0
expected buffer float 3 10.0
expected buffer float 4 11.0
#second invocation
expected buffer float 5 8.0
expected buffer float 6 9.0
expected buffer float 7 10.0
expected buffer float 8 11.0
expected buffer float 9 12.0

probe xfb buffer float 1 10


verify program_query GL_TRANSFORM_FEEDBACK_VARYINGS 5